<h1 id="end-to-end-flow-github-copilot-agent-with-custom-mcp-server-realistic-implementation">ğŸš€ End-to-End Flow: GitHub Copilot Agent with Custom MCP Server (Realistic Implementation)</h1>
<h2 id="overview">ğŸ“‹ Overview</h2>
<p>This document details the <strong>realistic</strong> end-to-end workflow of a user interacting with <strong>GitHub Copilot's Agent Mode</strong> to execute tasks against <strong>Rally</strong> through a custom <strong>MCP (Model Context Protocol)</strong> server. </p>
<p><strong>âš ï¸ IMPORTANT</strong>: This documentation reflects the <strong>actual capabilities and limitations</strong> of GitHub Copilot Agent, including the fact that it <strong>cannot render interactive links</strong> or handle automated OAuth flows.</p>
<h3 id="key-implementation-realities">Key Implementation Realities:</h3>
<ul>
<li>âœ… <strong>Manual Authentication</strong>: Users must manually open browser and complete OAuth flows</li>
<li>âœ… <strong>Text-Based Instructions</strong>: Agent provides URLs as text (not clickable links)</li>
<li>âœ… <strong>User Confirmation Required</strong>: Users must confirm authentication completion before retry</li>
<li>âœ… <strong>Session-Based Token Management</strong>: MCP Server maintains tokens linked to Agent sessions</li>
</ul>
<h3 id="authentication-flow-summary">Authentication Flow Summary:</h3>
<ol>
<li><strong>Agent</strong> detects authentication needed and provides text instructions</li>
<li><strong>User</strong> manually opens authentication URL in browser  </li>
<li><strong>User</strong> completes OAuth flow and returns to Agent</li>
<li><strong>User</strong> confirms completion, triggering Agent retry</li>
<li><strong>MCP Server</strong> uses stored tokens for subsequent requests## ğŸ”’ Security Controls Implementation Analysis</li>
</ol>
<p>Since <strong>GitHub Copilot Agent</strong> and the underlying <strong>LLM</strong> are out-of-the-box services without access f## ğŸ”‘ Key Points</p>
<table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
<thead>
<tr>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Aspect</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ†” <strong>Session ID Management</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Generated once by Agent and used consistently to maintain state</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ” <strong>OAuth Flow</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">MCP server acts as OAuth client, handling entire flow including PKCE</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸŒ <strong>Manual Authentication</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>CRITICAL</strong>: User must manually open browser and complete OAuth (Agent cannot render interactive links)</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ’¬ <strong>User Confirmation Required</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">User must return to Agent and confirm "authentication complete" before retry</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ”„ <strong>Manual Retry Trigger</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Agent retries original request only after user confirmation (no automatic retry)</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ›¡ï¸ <strong>Security</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">PKCE prevents authorization code interception; state parameter binds authentication to request</td>
</tr>
</tbody>
</table>
<h2 id="github-copilot-limitations">âš ï¸ <strong>GitHub Copilot Limitations</strong></h2>
<table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
<thead>
<tr>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Limitation</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Impact</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Workaround</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>Cannot render clickable links</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">No interactive OAuth flows</td>
<td style="border: 1px solid #ddd; padding: 12px;">Provide text URLs for manual copying</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>Cannot open browser windows</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">No automatic OAuth initiation</td>
<td style="border: 1px solid #ddd; padding: 12px;">User must manually open authentication URLs</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>Cannot detect OAuth completion</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">No automatic request retry</td>
<td style="border: 1px solid #ddd; padding: 12px;">User must confirm completion before retry</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>Limited UI capabilities</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Text-only responses</td>
<td style="border: 1px solid #ddd; padding: 12px;">Clear step-by-step instructions in text format</td>
</tr>
</tbody>
</table>
<h2 id="realistic-implementation-pattern">âœ… <strong>Realistic Implementation Pattern</strong></h2>
<h3 id="what-github-copilot-can-do">What GitHub Copilot CAN Do:</h3>
<ul>
<li>âœ… Display text messages with URLs</li>
<li>âœ… Make HTTP requests to MCP Server</li>
<li>âœ… Wait for user text responses</li>
<li>âœ… Retry requests based on user confirmation</li>
<li>âœ… Maintain conversation context</li>
</ul>
<h3 id="what-github-copilot-cannot-do">What GitHub Copilot CANNOT Do:</h3>
<ul>
<li>âŒ Render clickable links or buttons</li>
<li>âŒ Open browser windows</li>
<li>âŒ Handle OAuth redirects directly</li>
<li>âŒ Detect external authentication completion</li>
<li>âŒ Automatic retry without user inputm security implementation, we must analyze which of the <strong>9 MCP Framework Security Controls</strong> from <a href="./SECURITY_CONTROLS_OVERVIEW.md">SECURITY_CONTROLS_OVERVIEW.md</a> can be effectively implemented on the MCP Server.</li>
</ul>
<h3 id="mcp-framework-security-controls-analysis-for-out-of-box-scenario">ğŸ¯ MCP Framework Security Controls Analysis for Out-of-Box Scenario</h3>
<p><strong>REVISED ANALYSIS</strong> - Based on actual end-to-end flow and data exchange patterns:</p>
<table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
<thead>
<tr>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;"><strong>Security Control</strong></th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;"><strong>Implementation</strong></th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;"><strong>Effectiveness</strong></th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;"><strong>Rationale</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>1. InputSanitizer</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âœ… <strong>MANDATORY</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸŸ¢ HIGH</td>
<td style="border: 1px solid #ddd; padding: 12px;">Agent sends user prompts/tool requests; server must prevent prompt injection, SQL injection, XSS attacks</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>2. GoogleCloudTokenValidator</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âŒ <strong>NOT APPLICABLE</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ï¿½ N/A</td>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>Copilot Agent runs on desktop VSCode, not GCP</strong>; uses Rally OAuth tokens, not Google Cloud tokens</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>3. SchemaValidator</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âœ… <strong>MANDATORY</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸŸ¢ HIGH</td>
<td style="border: 1px solid #ddd; padding: 12px;">Agent sends JSON-RPC 2.0 MCP messages; server must enforce protocol compliance and parameter validation</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>4. CredentialManager</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âœ… <strong>MANDATORY</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸŸ¢ HIGH</td>
<td style="border: 1px solid #ddd; padding: 12px;">Server stores Rally OAuth tokens, PKCE verifiers, and session data; requires secure credential management</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>5. ContextSanitizer</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âœ… <strong>MANDATORY</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸŸ¢ HIGH</td>
<td style="border: 1px solid #ddd; padding: 12px;">Server returns Rally API responses to Agent; must sanitize PII, sensitive data before LLM processing</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>6. ToolExposureController</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âœ… <strong>MANDATORY</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸŸ¢ HIGH</td>
<td style="border: 1px solid #ddd; padding: 12px;">Server controls which Rally tools are available; manages access policies and user authorization</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>7. ServerNameRegistry</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ”¶ <strong>OPTIONAL</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸŸ¡ MEDIUM</td>
<td style="border: 1px solid #ddd; padding: 12px;">Could validate MCP server identity in multi-server setups; limited value in single Rally integration</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>8. SemanticMappingValidator</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ”¶ <strong>OPTIONAL</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸŸ¡ MEDIUM</td>
<td style="border: 1px solid #ddd; padding: 12px;">Validates Rally tool metadata consistency; useful for dynamic tool registration scenarios</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>9. OPAPolicyClient</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âŒ <strong>SKIP</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ”´ LOW</td>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>No rich policy context available</strong>; desktop Agent provides minimal user context; use static policies instead</td>
</tr>
</tbody>
</table>
<h3 id="security-architecture-for-github-copilot-agent-mcp-server-integration">ğŸ›¡ï¸ Security Architecture for GitHub Copilot Agent + MCP Server Integration</h3>
<div class="codehilite"><pre><span></span><code><span class="nf">graph</span><span class="w"> </span><span class="n">TB</span>
<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;DESKTOP ENVIRONMENT (Limited Security Control)&quot;</span>
<span class="w">        </span><span class="n">CA</span><span class="p">[</span><span class="n">GitHub</span><span class="w"> </span><span class="n">Copilot</span><span class="w"> </span><span class="n">Agent</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">âŒ</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="n">Implementation</span><span class="w"> </span><span class="n">Access</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ”’</span><span class="w"> </span><span class="n">Microsoft</span><span class="w"> </span><span class="n">Managed</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ“</span><span class="w"> </span><span class="n">Desktop</span><span class="w"> </span><span class="n">VSCode</span><span class="p">]</span>
<span class="w">        </span><span class="n">LLM</span><span class="p">[</span><span class="n">Underlying</span><span class="w"> </span><span class="n">LLM</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">âŒ</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="n">Implementation</span><span class="w"> </span><span class="n">Access</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ”’</span><span class="w"> </span><span class="n">OpenAI</span><span class="o">/</span><span class="n">Microsoft</span><span class="w"> </span><span class="n">Managed</span><span class="p">]</span>
<span class="w">    </span><span class="kd">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;CUSTOM MCP SERVER (5 Mandatory + 2 Optional Controls)&quot;</span>
<span class="w">        </span><span class="n">MCP</span><span class="p">[</span><span class="n">MCP</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">FastMCP</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">âœ…</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">MANDATORY</span><span class="w"> </span><span class="n">Security</span><span class="w"> </span><span class="n">Controls</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ”¶</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">OPTIONAL</span><span class="w"> </span><span class="n">Controls</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">âŒ</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="kr">NOT</span><span class="w"> </span><span class="n">APPLICABLE</span><span class="w"> </span><span class="n">Controls</span><span class="p">]</span>

<span class="w">        </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;MANDATORY CONTROLS (Required for Production)&quot;</span>
<span class="w">            </span><span class="n">SC1</span><span class="p">[</span><span class="mf">1.</span><span class="w"> </span><span class="n">InputSanitizer</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ”</span><span class="w"> </span><span class="n">Prompt</span><span class="w"> </span><span class="n">Injection</span><span class="w"> </span><span class="n">Protection</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ï¿½</span><span class="w"> </span><span class="n">Rally</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="n">Validation</span><span class="p">]</span>
<span class="w">            </span><span class="n">SC3</span><span class="p">[</span><span class="mf">3.</span><span class="w"> </span><span class="n">SchemaValidator</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ“‹</span><span class="w"> </span><span class="n">JSON</span><span class="o">-</span><span class="n">RPC</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="n">Compliance</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">âœ…</span><span class="w"> </span><span class="n">Pydantic</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="n">Validation</span><span class="p">]</span>
<span class="w">            </span><span class="n">SC4</span><span class="p">[</span><span class="mf">4.</span><span class="w"> </span><span class="n">CredentialManager</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ—„ï¸</span><span class="w"> </span><span class="n">Rally</span><span class="w"> </span><span class="n">OAuth</span><span class="w"> </span><span class="kt">Token</span><span class="w"> </span><span class="n">Storage</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ”</span><span class="w"> </span><span class="n">PKCE</span><span class="w"> </span><span class="n">Verifier</span><span class="w"> </span><span class="n">Management</span><span class="p">]</span>
<span class="w">            </span><span class="n">SC5</span><span class="p">[</span><span class="mf">5.</span><span class="w"> </span><span class="n">ContextSanitizer</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ§¹</span><span class="w"> </span><span class="n">Rally</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">Sanitization</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸš«</span><span class="w"> </span><span class="n">PII</span><span class="w"> </span><span class="n">Protection</span><span class="p">]</span>
<span class="w">            </span><span class="n">SC6</span><span class="p">[</span><span class="mf">6.</span><span class="w"> </span><span class="n">ToolExposureController</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ¯</span><span class="w"> </span><span class="n">Rally</span><span class="w"> </span><span class="n">Tool</span><span class="w"> </span><span class="n">Access</span><span class="w"> </span><span class="n">Control</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ“</span><span class="w"> </span><span class="n">Session</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">Authorization</span><span class="p">]</span>
<span class="w">        </span><span class="kd">end</span>

<span class="w">        </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;OPTIONAL CONTROLS (Enhanced Security)&quot;</span>
<span class="w">            </span><span class="n">SC7</span><span class="p">[</span><span class="mf">7.</span><span class="w"> </span><span class="n">ServerNameRegistry</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ·ï¸</span><span class="w"> </span><span class="n">MCP</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">Identity</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ”</span><span class="w"> </span><span class="n">Multi</span><span class="o">-</span><span class="n">server</span><span class="w"> </span><span class="n">Validation</span><span class="p">]</span>
<span class="w">            </span><span class="n">SC8</span><span class="p">[</span><span class="mf">8.</span><span class="w"> </span><span class="n">SemanticMappingValidator</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ”</span><span class="w"> </span><span class="n">Rally</span><span class="w"> </span><span class="n">Tool</span><span class="w"> </span><span class="n">Metadata</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ“Š</span><span class="w"> </span><span class="n">Dynamic</span><span class="w"> </span><span class="n">Tool</span><span class="w"> </span><span class="n">Validation</span><span class="p">]</span>
<span class="w">        </span><span class="kd">end</span>

<span class="w">        </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;NOT APPLICABLE CONTROLS&quot;</span>
<span class="w">            </span><span class="n">SC2</span><span class="p">[</span><span class="mf">2.</span><span class="w"> </span><span class="n">GoogleCloudTokenValidator</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">âŒ</span><span class="w"> </span><span class="kr">NOT</span><span class="w"> </span><span class="n">APPLICABLE</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ“</span><span class="w"> </span><span class="n">Desktop</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="err">â‰ </span><span class="w"> </span><span class="n">GCP</span><span class="w"> </span><span class="n">Environment</span><span class="p">]</span>
<span class="w">            </span><span class="n">SC9</span><span class="p">[</span><span class="mf">9.</span><span class="w"> </span><span class="n">OPAPolicyClient</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">âŒ</span><span class="w"> </span><span class="kr">NOT</span><span class="w"> </span><span class="n">APPLICABLE</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">âš ï¸</span><span class="w"> </span><span class="n">Limited</span><span class="w"> </span><span class="n">desktop</span><span class="w"> </span><span class="n">context</span><span class="p">]</span>
<span class="w">        </span><span class="kd">end</span>
<span class="w">    </span><span class="kd">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;RALLY BUSINESS SYSTEM&quot;</span>
<span class="w">        </span><span class="n">RALLY</span><span class="p">[</span><span class="n">Rally</span><span class="w"> </span><span class="n">API</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ”</span><span class="w"> </span><span class="n">Rally</span><span class="w"> </span><span class="n">OAuth</span><span class="w"> </span><span class="mf">2.1</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">ğŸ“Š</span><span class="w"> </span><span class="n">Enterprise</span><span class="w"> </span><span class="n">ALM</span><span class="w"> </span><span class="n">Data</span><span class="p">]</span>
<span class="w">    </span><span class="kd">end</span>

<span class="w">    </span><span class="n">CA</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">Unsecured</span><span class="w"> </span><span class="n">Requests</span><span class="o">|</span><span class="w"> </span><span class="n">MCP</span>
<span class="w">    </span><span class="n">LLM</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">AI</span><span class="w"> </span><span class="n">Processing</span><span class="o">|</span><span class="w"> </span><span class="n">CA</span>

<span class="w">    </span><span class="n">MCP</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">SC1</span>
<span class="w">    </span><span class="n">MCP</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">SC2</span>
<span class="w">    </span><span class="n">MCP</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">SC3</span>
<span class="w">    </span><span class="n">MCP</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">SC4</span>
<span class="w">    </span><span class="n">MCP</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">SC5</span>
<span class="w">    </span><span class="n">MCP</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">SC6</span>
<span class="w">    </span><span class="n">MCP</span><span class="w"> </span><span class="o">-</span><span class="p">.</span><span class="o">-&gt;</span><span class="w"> </span><span class="n">SC7</span>
<span class="w">    </span><span class="n">MCP</span><span class="w"> </span><span class="o">-</span><span class="p">.</span><span class="o">-&gt;</span><span class="w"> </span><span class="n">SC8</span>

<span class="w">    </span><span class="n">MCP</span><span class="w"> </span><span class="o">--&gt;|</span><span class="n">Secured</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">Calls</span><span class="o">|</span><span class="w"> </span><span class="n">RALLY</span>

<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">CA</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">ffebee</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="n">d32f2f</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">3</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">LLM</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">ffebee</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="n">d32f2f</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">3</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">MCP</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">e8f5e8</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="mf">2e7</span><span class="n">d32</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">4</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">SC1</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">c8e6c9</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="mf">2e7</span><span class="n">d32</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">2</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">SC2</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">c8e6c9</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="mf">2e7</span><span class="n">d32</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">2</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">SC3</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">c8e6c9</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="mf">2e7</span><span class="n">d32</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">2</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">SC4</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">c8e6c9</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="mf">2e7</span><span class="n">d32</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">2</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">SC5</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">c8e6c9</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="mf">2e7</span><span class="n">d32</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">2</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">SC6</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">c8e6c9</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="mf">2e7</span><span class="n">d32</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">2</span><span class="n">px</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">SC7</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">fff9c4</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="n">f57f17</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">2</span><span class="n">px</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">dasharray</span><span class="o">:</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">SC8</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">fff9c4</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="n">f57f17</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">2</span><span class="n">px</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">dasharray</span><span class="o">:</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">SC9</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">ffebee</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="n">d32f2f</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">2</span><span class="n">px</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">dasharray</span><span class="o">:</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">5</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">RALLY</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">fff3e0</span><span class="p">,</span><span class="n">stroke</span><span class="o">:</span><span class="err">#</span><span class="n">ef6c00</span><span class="p">,</span><span class="n">stroke</span><span class="o">-</span><span class="n">width</span><span class="o">:</span><span class="mi">3</span><span class="n">px</span>
</code></pre></div></div>

<h3 id="security-implementation-mapping-for-out-of-box-scenario">ğŸ” Security Implementation Mapping for Out-of-Box Scenario</h3>
<h4 id="phase-1-critical-security-foundation-6-mandatory-controls"><strong>Phase 1: Critical Security Foundation (6 Mandatory Controls)</strong></h4>
<h5 id="1-inputsanitizer-request-validation"><strong>1. InputSanitizer - Request Validation</strong></h5>
<div class="codehilite"><pre><span></span><code><span class="err">POST /tools/create_rally_story</span>
<span class="err">Headers: Authorization: Bearer &lt;oauth_token&gt;</span>
<span class="err">Content: &lt;user_query&gt;</span>

<span class="err">MCP Server Processing:</span>
<span class="err">âœ… InputSanitizer.sanitize_string(user_query)</span>
<span class="err">- Detect prompt injection patterns</span>
<span class="err">- Filter SQL injection attempts  </span>
<span class="err">- Block XSS and command injection</span>
<span class="err">- Apply HTML escaping and content filtering</span>
</code></pre></div></div>

<h5 id="2-googlecloudtokenvalidator-oauth-authentication"><strong>2. GoogleCloudTokenValidator - OAuth Authentication</strong></h5>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;cloudRunHeaders&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;X-Goog-Authenticated-User-Email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;service-account@project.iam.gserviceaccount.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;X-Goog-Authenticated-User-ID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user-id&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;validation&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Automatic Cloud Run token validation&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;fallback&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JWT validation with google.auth library&quot;</span>
<span class="p">}</span>
</code></pre></div></div>

<h5 id="3-schemavalidator-protocol-compliance"><strong>3. SchemaValidator - Protocol Compliance</strong></h5>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tools/list&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;validation&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;JSON-RPC 2.0 structure + MCP security rules&quot;</span>
<span class="p">}</span>
</code></pre></div></div>

<h5 id="4-credentialmanager-secret-management"><strong>4. CredentialManager - Secret Management</strong></h5>
<div class="codehilite"><pre><span></span><code><span class="c1"># Secure credential injection from Google Cloud Secret Manager</span>
<span class="n">credentials</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;rally_api_key&quot;</span><span class="p">:</span> <span class="n">secret_manager</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="s2">&quot;rally-api-key&quot;</span><span class="p">),</span>
    <span class="s2">&quot;oauth_client_secret&quot;</span><span class="p">:</span> <span class="n">secret_manager</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="s2">&quot;oauth-client-secret&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h5 id="5-contextsanitizer-response-protection"><strong>5. ContextSanitizer - Response Protection</strong></h5>
<div class="codehilite"><pre><span></span><code><span class="c1"># Model Armor integration with regex fallback</span>
<span class="n">sanitized_response</span> <span class="o">=</span> <span class="n">context_sanitizer</span><span class="o">.</span><span class="n">sanitize</span><span class="p">({</span>
    <span class="s2">&quot;model_armor_api&quot;</span><span class="p">:</span> <span class="s2">&quot;Advanced threat detection&quot;</span><span class="p">,</span>
    <span class="s2">&quot;regex_fallback&quot;</span><span class="p">:</span> <span class="s2">&quot;PII pattern matching&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pii_redaction&quot;</span><span class="p">:</span> <span class="s2">&quot;[EMAIL-REDACTED], [SSN-REDACTED]&quot;</span>
<span class="p">})</span>
</code></pre></div></div>

<h5 id="6-toolexposurecontroller-access-control"><strong>6. ToolExposureController - Access Control</strong></h5>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;policy&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;service_accounts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;copilot@project.iam.gserviceaccount.com&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;allowed_tools&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;create_rally_story&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;get_rally_data&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;approval_required&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="phase-2-optional-controls-2-controls"><strong>Phase 2: Optional Controls (2 Controls)</strong></h4>
<h5 id="7-servernameregistry-identity-verification"><strong>7. ServerNameRegistry - Identity Verification</strong></h5>
<div class="codehilite"><pre><span></span><code><span class="c1"># Server identity management (useful for multi-server setups)</span>
<span class="n">server_registry</span><span class="o">.</span><span class="n">register_server</span><span class="p">(</span>
    <span class="n">server_id</span><span class="o">=</span><span class="s2">&quot;rally-mcp-server&quot;</span><span class="p">,</span>
    <span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;enterprise&quot;</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;rally_create&quot;</span><span class="p">,</span> <span class="s2">&quot;rally_read&quot;</span><span class="p">,</span> <span class="s2">&quot;rally_update&quot;</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div></div>

<h5 id="8-semanticmappingvalidator-tool-metadata-validation"><strong>8. SemanticMappingValidator - Tool Metadata Validation</strong></h5>
<div class="codehilite"><pre><span></span><code><span class="c1"># Tool metadata consistency validation</span>
<span class="n">semantic_validator</span><span class="o">.</span><span class="n">validate_tool_semantics</span><span class="p">(</span>
    <span class="n">tool_name</span><span class="o">=</span><span class="s2">&quot;create_rally_story&quot;</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;data_access&quot;</span><span class="p">,</span> <span class="s2">&quot;output_type&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">}</span>
<span class="p">)</span>
</code></pre></div></div>

<h4 id="phase-3-skipped-control-1-control"><strong>Phase 3: Skipped Control (1 Control)</strong></h4>
<h5 id="9-opapolicyclient-policy-engine"><strong>9. OPAPolicyClient - Policy Engine</strong></h5>
<div class="codehilite"><pre><span></span><code><span class="c1"># âŒ SKIP: Limited effectiveness in out-of-box scenario</span>
<span class="c1"># Reason: Agent provides minimal context (only service account from OAuth)</span>
<span class="c1"># Cannot build rich policy context for dynamic authorization</span>
<span class="c1"># Alternative: Use ToolExposureController with static service account policies</span>
</code></pre></div></div>

<h3 id="security-architecture-constraints-analysis">âš ï¸ Security Architecture Constraints Analysis</h3>
<table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
<thead>
<tr>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;"><strong>Component</strong></th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;"><strong>Security Capability</strong></th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;"><strong>Implementation Strategy</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>GitHub Copilot Agent</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âŒ No custom security access</td>
<td style="border: 1px solid #ddd; padding: 12px;">Microsoft managed - cannot modify</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>Underlying LLM</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âŒ No custom security access</td>
<td style="border: 1px solid #ddd; padding: 12px;">OpenAI/Microsoft managed - cannot modify</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>MCP Server</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âœ… Full security control</td>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>6 mandatory + 2 optional controls</strong></td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>Business APIs</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âš¡ Existing enterprise security</td>
<td style="border: 1px solid #ddd; padding: 12px;">Protected by MCP Server security gateway</td>
</tr>
</tbody>
</table>
<h3 id="critical-security-recommendations-for-out-of-box-integration">ğŸ¯ Critical Security Recommendations for Out-of-Box Integration</h3>
<ol>
<li><strong>Mandatory Controls First</strong>: Implement 5 critical controls before deployment</li>
<li><strong>Server-Side Defense</strong>: All security must be on MCP Server due to Agent/LLM constraints  </li>
<li><strong>Rally OAuth Security</strong>: Leverage PKCE and secure token storage instead of Google Cloud tokens</li>
<li><strong>Response Sanitization</strong>: Critical since no control over Agent response handling</li>
<li><strong>Session-based Authorization</strong>: Use session mappings and static policies for desktop scenarios</li>
</ol>
<h3 id="security-implementation-priority">ğŸ”’ Security Implementation Priority</h3>
<table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
<thead>
<tr>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;"><strong>Priority</strong></th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;"><strong>Security Controls</strong></th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;"><strong>Implementation Timeline</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>P0 - Critical</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">InputSanitizer, SchemaValidator</td>
<td style="border: 1px solid #ddd; padding: 12px;">Deploy before any user access</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>P1 - High</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">CredentialManager, ContextSanitizer</td>
<td style="border: 1px solid #ddd; padding: 12px;">Deploy before production</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>P2 - High</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ToolExposureController</td>
<td style="border: 1px solid #ddd; padding: 12px;">Deploy before production</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>P3 - Optional</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ServerNameRegistry, SemanticMappingValidator</td>
<td style="border: 1px solid #ddd; padding: 12px;">Deploy for enhanced security</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>P4 - Not Applicable</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">GoogleCloudTokenValidator, OPAPolicyClient</td>
<td style="border: 1px solid #ddd; padding: 12px;">Skip for desktop Agent scenarios</td>
</tr>
</tbody>
</table>
<h3 id="security-implementation-summary-for-desktop-agent-scenario">ğŸ”’ Security Implementation Summary for Desktop Agent Scenario</h3>
<table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
<thead>
<tr>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Security Control</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Implementation Status</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Technology Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ” <strong>InputSanitizer</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âœ… MANDATORY on MCP Server</td>
<td style="border: 1px solid #ddd; padding: 12px;">Regex patterns, HTML escaping, FastAPI validation</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">âŒ <strong>GoogleCloudTokenValidator</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âŒ NOT APPLICABLE</td>
<td style="border: 1px solid #ddd; padding: 12px;">Desktop Agent â‰  GCP environment</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">âœ… <strong>SchemaValidator</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âœ… MANDATORY on MCP Server</td>
<td style="border: 1px solid #ddd; padding: 12px;">Pydantic models, JSON-RPC 2.0 compliance</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ¯ <strong>CredentialManager</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âœ… MANDATORY on MCP Server</td>
<td style="border: 1px solid #ddd; padding: 12px;">SQLite/PostgreSQL, Rally OAuth tokens, PKCE storage</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ§¹ <strong>ContextSanitizer</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âœ… MANDATORY on MCP Server</td>
<td style="border: 1px solid #ddd; padding: 12px;">Regex filtering, PII detection, response sanitization</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ² <strong>ToolExposureController</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âœ… MANDATORY on MCP Server</td>
<td style="border: 1px solid #ddd; padding: 12px;">Session-based policies, Rally tool authorization</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ·ï¸ <strong>ServerNameRegistry</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ”¶ OPTIONAL on MCP Server</td>
<td style="border: 1px solid #ddd; padding: 12px;">Server identity validation, multi-server scenarios</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ” <strong>SemanticMappingValidator</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ”¶ OPTIONAL on MCP Server</td>
<td style="border: 1px solid #ddd; padding: 12px;">Rally tool metadata validation, dynamic registration</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">âŒ <strong>OPAPolicyClient</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">âŒ NOT APPLICABLE</td>
<td style="border: 1px solid #ddd; padding: 12px;">Limited desktop context, use static policies instead</td>
</tr>
</tbody>
</table>
<h3 id="security-coverage-analysis">ğŸ“Š Security Coverage Analysis</h3>
<p><strong>âœ… Comprehensive Protection (5 Mandatory Controls)</strong><br />
- All critical attack vectors covered by MCP Server<br />
- Defense-in-depth with multiple security layers<br />
- Rally OAuth 2.1 integration with PKCE authentication<br />
- Advanced response sanitization and PII protection</p>
<p><strong>ğŸ”¶ Enhanced Features (2 Optional Controls)</strong><br />
- Server identity verification for multi-server environments<br />
- Tool metadata validation for dynamic tool scenarios</p>
<p><strong>âŒ Not Applicable (2 Controls)</strong><br />
- Cannot implement Google Cloud token validation (desktop environment)<br />
- Cannot implement rich context-aware policies (use static session policies instead)<br />
- Limited visibility into Agent/LLM internal processing<br />
- Must rely on Rally OAuth 2.1 and session-based permissions for user authorization</p>
<p>This security analysis ensures that all practical and effective security controls from the MCP Framework are properly implemented for desktop Agent integration scenarios, with clear prioritization and evidence-based implementation guidance.</p>
<h3 id="detailed-security-control-analysis-based-on-data-flow">ğŸ” <strong>Detailed Security Control Analysis Based on Data Flow</strong></h3>
<h4 id="data-exchange-points-in-the-end-to-end-flow"><strong>Data Exchange Points in the End-to-End Flow:</strong></h4>
<p><strong>1. Agent â†’ MCP Server (Tool Request)</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;tools/call&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nt">&quot;params&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;create_story&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;User Story: Login functionality&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;As a user I want to...&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;points&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Session-ID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;abc123xyz789&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Required Controls:</strong><br />
- âœ… <strong>InputSanitizer</strong>: Validates <code>title</code>, <code>description</code> for injection attacks<br />
- âœ… <strong>SchemaValidator</strong>: Validates JSON-RPC 2.0 structure and parameters<br />
- âœ… <strong>CredentialManager</strong>: Validates <code>Session-ID</code> and retrieves stored tokens</p>
<p><strong>2. MCP Server â†’ Agent (401 Authentication Required)</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Authentication required&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;auth_url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://mcp-server.com/auth?state=abc&amp;code_challenge=xyz&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;instructions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;Copy URL and authenticate in browser&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Required Controls:</strong><br />
- âœ… <strong>ContextSanitizer</strong>: Ensures auth URLs are safe and don't leak sensitive data<br />
- âœ… <strong>ToolExposureController</strong>: Controls which tools require authentication</p>
<p><strong>3. MCP Server â†” Rally API (Authenticated Requests)</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;HierarchicalRequirement&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;User Story: Login functionality&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nt">&quot;Description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;As a user I want to...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;PlanEstimate&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Required Controls:</strong><br />
- âœ… <strong>CredentialManager</strong>: Manages Rally OAuth tokens and PKCE verifiers<br />
- âœ… <strong>InputSanitizer</strong>: Validates data before sending to Rally API<br />
- âœ… <strong>ContextSanitizer</strong>: Sanitizes Rally responses before returning to Agent</p>
<p><strong>4. MCP Server â†’ Agent (Rally Response)</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;story&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;12345&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;formatted_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;US1234&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;User Story: Login functionality&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://rally1.rallydev.com/#/detail/userstory/12345&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Required Controls:</strong><br />
- âœ… <strong>ContextSanitizer</strong>: Removes PII, sensitive URLs, internal Rally data<br />
- âœ… <strong>ToolExposureController</strong>: Controls which Rally data fields are exposed</p>
<h4 id="why-specific-controls-are-not-applicable"><strong>Why Specific Controls Are NOT APPLICABLE:</strong></h4>
<p><strong>âŒ GoogleCloudTokenValidator:</strong><br />
- <strong>Reason</strong>: GitHub Copilot Agent runs on desktop VSCode, not in GCP<br />
- <strong>Alternative</strong>: Rally OAuth 2.1 tokens with PKCE validation<br />
- <strong>Data Evidence</strong>: No <code>X-Goog-Authenticated-User-Email</code> headers in desktop scenarios</p>
<p><strong>âŒ OPAPolicyClient:</strong><br />
- <strong>Reason</strong>: Desktop Agent provides minimal context (no user roles, departments, etc.)<br />
- <strong>Alternative</strong>: Static session-based policies via ToolExposureController<br />
- <strong>Data Evidence</strong>: Limited contextual information from desktop environment</p>
<hr />
<h2 id="prerequisites">ğŸ”§ Prerequisites</h2>
<table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
<thead>
<tr>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Component</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ”¨ <strong>VS Code IDE</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">GitHub Copilot Agent Mode enabled</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">â˜ï¸ <strong>Custom MCP Server</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Deployed on Google Cloud Platform (GCP)</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ” <strong>Rally OAuth App</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Application registration completed</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">âš™ï¸ <strong>mcp.json</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Configuration file properly set up</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="sequence-diagram">ğŸŒŠ Sequence Diagram</h2>
<div class="codehilite"><pre><span></span><code><span class="n">sequenceDiagram</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">User</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Copilot</span><span class="w"> </span><span class="n">Agent</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">MCP</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">MCP</span><span class="w"> </span><span class="n">Server</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">AuthSrv</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Rally</span><span class="w"> </span><span class="n">Auth</span><span class="w"> </span><span class="n">Server</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">Browser</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">User</span><span class="s1">&#39;s Browser</span>

<span class="w">    </span><span class="n">User</span><span class="o">-&gt;&gt;</span><span class="n">Agent</span><span class="p">:</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="s2">&quot;Create a Rally story&quot;</span>
<span class="w">    </span><span class="n">Agent</span><span class="o">-&gt;&gt;</span><span class="n">MCP</span><span class="p">:</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">create</span><span class="o">-</span><span class="n">story</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">Session</span><span class="o">-</span><span class="n">ID</span><span class="p">:</span><span class="w"> </span><span class="n">session_123</span>
<span class="w">    </span><span class="n">MCP</span><span class="o">-&gt;&gt;</span><span class="n">MCP</span><span class="p">:</span><span class="w"> </span><span class="mf">3.</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">session_123</span>
<span class="w">    </span><span class="n">MCP</span><span class="o">-&gt;&gt;</span><span class="n">MCP</span><span class="p">:</span><span class="w"> </span><span class="mf">4.</span><span class="w"> </span><span class="n">Generate</span><span class="w"> </span><span class="n">PKCE</span><span class="w"> </span><span class="n">parameters</span><span class="p">:</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">code_verifier</span><span class="p">:</span><span class="w"> </span><span class="n">random_string_43_128_chars</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">code_challenge</span><span class="p">:</span><span class="w"> </span><span class="n">SHA256</span><span class="p">(</span><span class="n">code_verifier</span><span class="p">)</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="n">cryptographically_random_token</span>
<span class="w">    </span><span class="n">MCP</span><span class="o">-&gt;&gt;</span><span class="n">Agent</span><span class="p">:</span><span class="w"> </span><span class="mf">5.</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="mi">401</span><span class="w"> </span><span class="n">Unauthorized</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">Authentication</span><span class="w"> </span><span class="n">Required</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">auth_url</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://mcp.example.com/auth?state=xyz789&amp;code_challenge=abc123def&quot;</span>

<span class="w">    </span><span class="n">Agent</span><span class="o">-&gt;&gt;</span><span class="n">User</span><span class="p">:</span><span class="w"> </span><span class="mf">6.</span><span class="w"> </span><span class="n">Display</span><span class="w"> </span><span class="n">message</span><span class="p">:</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="s2">&quot;ğŸ” Authentication required for Rally access.&lt;br&gt;Please visit: https://mcp.example.com/auth?state=xyz789&amp;code_challenge=abc123def&lt;br&gt;Then return here and say &#39;authentication complete&#39;&quot;</span>

<span class="w">    </span><span class="n">Note</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">User</span><span class="p">,</span><span class="n">Browser</span><span class="p">:</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">manually</span><span class="w"> </span><span class="n">opens</span><span class="w"> </span><span class="n">browser</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">completes</span><span class="w"> </span><span class="n">OAuth</span><span class="w"> </span><span class="n">flow</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">PKCE</span>
<span class="w">    </span><span class="n">User</span><span class="o">-&gt;&gt;</span><span class="n">Browser</span><span class="p">:</span><span class="w"> </span><span class="mf">7.</span><span class="w"> </span><span class="n">Opens</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">browser</span><span class="w"> </span><span class="p">(</span><span class="n">includes</span><span class="w"> </span><span class="n">code_challenge</span><span class="p">)</span>
<span class="w">    </span><span class="n">Browser</span><span class="o">-&gt;&gt;</span><span class="n">MCP</span><span class="p">:</span><span class="w"> </span><span class="mf">8.</span><span class="w"> </span><span class="n">GET</span><span class="w"> </span><span class="o">/</span><span class="n">auth</span><span class="err">?</span><span class="n">state</span><span class="o">=</span><span class="n">xyz789</span><span class="o">&amp;</span><span class="n">code_challenge</span><span class="o">=</span><span class="n">abc123def</span>
<span class="w">    </span><span class="n">MCP</span><span class="o">-&gt;&gt;</span><span class="n">MCP</span><span class="p">:</span><span class="w"> </span><span class="mf">9.</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="n">code_verifier</span><span class="w"> </span><span class="n">linked</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">token</span>
<span class="w">    </span><span class="n">MCP</span><span class="o">-&gt;&gt;</span><span class="n">Browser</span><span class="p">:</span><span class="w"> </span><span class="mf">10.</span><span class="w"> </span><span class="n">Redirect</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Rally</span><span class="w"> </span><span class="n">OAuth</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">PKCE</span><span class="w"> </span><span class="n">parameters</span><span class="p">:</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">code_challenge</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">code_challenge_method</span><span class="o">=</span><span class="n">S256</span>
<span class="w">    </span><span class="n">Browser</span><span class="o">-&gt;&gt;</span><span class="n">AuthSrv</span><span class="p">:</span><span class="w"> </span><span class="mf">11.</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">authenticates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">consents</span><span class="w"> </span><span class="p">(</span><span class="n">OAuth</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">validates</span><span class="w"> </span><span class="n">code_challenge</span><span class="p">)</span>
<span class="w">    </span><span class="n">AuthSrv</span><span class="o">-&gt;&gt;</span><span class="n">MCP</span><span class="p">:</span><span class="w"> </span><span class="mf">12.</span><span class="w"> </span><span class="n">Redirect</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">/</span><span class="n">callback</span><span class="err">?</span><span class="n">code</span><span class="o">=</span><span class="n">auth_code_123</span><span class="o">&amp;</span><span class="n">state</span><span class="o">=</span><span class="n">xyz789</span>
<span class="w">    </span><span class="n">MCP</span><span class="o">-&gt;&gt;</span><span class="n">MCP</span><span class="p">:</span><span class="w"> </span><span class="mf">13.</span><span class="w"> </span><span class="n">Retrieve</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="n">code_verifier</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">state</span><span class="o">=</span><span class="n">xyz789</span>
<span class="w">    </span><span class="n">MCP</span><span class="o">-&gt;&gt;</span><span class="n">AuthSrv</span><span class="p">:</span><span class="w"> </span><span class="mf">14.</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">token</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">code</span><span class="o">=</span><span class="n">auth_code_123</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">code_verifier</span><span class="o">=</span><span class="n">original_random_string</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">client_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">redirect_uri</span>
<span class="w">    </span><span class="n">AuthSrv</span><span class="o">-&gt;&gt;</span><span class="n">AuthSrv</span><span class="p">:</span><span class="w"> </span><span class="mf">15.</span><span class="w"> </span><span class="n">Verify</span><span class="p">:</span><span class="w"> </span><span class="n">SHA256</span><span class="p">(</span><span class="n">code_verifier</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">code_challenge</span>
<span class="w">    </span><span class="n">AuthSrv</span><span class="o">-&gt;&gt;</span><span class="n">MCP</span><span class="p">:</span><span class="w"> </span><span class="mf">16.</span><span class="w"> </span><span class="n">access_token</span><span class="p">,</span><span class="w"> </span><span class="n">refresh_token</span><span class="w"> </span><span class="p">(</span><span class="n">PKCE</span><span class="w"> </span><span class="n">validation</span><span class="w"> </span><span class="n">passed</span><span class="p">)</span>
<span class="w">    </span><span class="n">MCP</span><span class="o">-&gt;&gt;</span><span class="n">MCP</span><span class="p">:</span><span class="w"> </span><span class="mf">17.</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">session_123</span><span class="w"> </span><span class="p">(</span><span class="n">linked</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">state</span><span class="p">)</span>
<span class="w">    </span><span class="n">MCP</span><span class="o">-&gt;&gt;</span><span class="n">Browser</span><span class="p">:</span><span class="w"> </span><span class="mf">18.</span><span class="w"> </span><span class="s2">&quot;âœ… Authentication successful! You can now close this tab and return to VSCode.&quot;</span>

<span class="w">    </span><span class="n">User</span><span class="o">-&gt;&gt;</span><span class="n">Agent</span><span class="p">:</span><span class="w"> </span><span class="mf">19.</span><span class="w"> </span><span class="s2">&quot;Authentication complete&quot;</span>
<span class="w">    </span><span class="n">Agent</span><span class="o">-&gt;&gt;</span><span class="n">MCP</span><span class="p">:</span><span class="w"> </span><span class="mf">20.</span><span class="w"> </span><span class="n">RETRY</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">create</span><span class="o">-</span><span class="n">story</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">Session</span><span class="o">-</span><span class="n">ID</span><span class="p">:</span><span class="w"> </span><span class="n">session_123</span>
<span class="w">    </span><span class="n">MCP</span><span class="o">-&gt;&gt;</span><span class="n">MCP</span><span class="p">:</span><span class="w"> </span><span class="mf">21.</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">session_123</span>
<span class="w">    </span><span class="n">MCP</span><span class="o">-&gt;&gt;</span><span class="n">MCP</span><span class="p">:</span><span class="w"> </span><span class="mf">22.</span><span class="w"> </span><span class="n">Execute</span><span class="w"> </span><span class="k">tool</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="n">tokens</span>
<span class="w">    </span><span class="n">MCP</span><span class="o">-&gt;&gt;</span><span class="n">Agent</span><span class="p">:</span><span class="w"> </span><span class="mf">23.</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="n">OK</span><span class="p">:</span><span class="w"> </span><span class="n">Story</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">successfully</span>
<span class="w">    </span><span class="n">Agent</span><span class="o">-&gt;&gt;</span><span class="n">User</span><span class="p">:</span><span class="w"> </span><span class="mf">24.</span><span class="w"> </span><span class="s2">&quot;âœ… Rally story created successfully!&quot;</span>
</code></pre></div></div>

<hr />
<h2 id="step-by-step-explanation">ğŸ“– Step-by-Step Explanation</h2>
<h3 id="1-agent-initialization-in-vscode">1. ğŸš€ Agent Initialization in VSCode</h3>
<p>When the Copilot Agent starts in VSCode:</p>
<ul>
<li><strong>Generates</strong> a unique Session ID (UUID)</li>
<li><strong>Stores</strong> it in environment variable <code>COPILOT_MCP_SESSION_ID</code></li>
<li><strong>Persists</strong> for the Agent's lifetime to identify all requests from this IDE session</li>
</ul>
<h3 id="2-user-query">2. ğŸ’¬ User Query</h3>
<p>User types a query in Copilot chat requiring Rally interaction:</p>
<blockquote style="border-left: 4px solid #0078d4; margin: 16px 0; padding-left: 16px; color: #605e5c; font-style: italic;">
<p><strong>Example:</strong> <em>"Create a Rally story for task X"</em></p>
</blockquote>
<ul>
<li>Copilot Agent <strong>parses</strong> the query</li>
<li><strong>Consults</strong> <code>mcp.json</code> to determine the appropriate MCP server</li>
</ul>
<h3 id="3-initial-request-to-mcp-server">3. ğŸ“¡ Initial Request to MCP Server</h3>
<p>Agent sends a request to the Rally MCP server:</p>
<div class="codehilite"><pre><span></span><code><span class="err">POST /tools/create_rally_story</span>
<span class="err">Headers: </span>
<span class="err">  Session-ID: &lt;session_id&gt;</span>
<span class="err">Content: &lt;query_parameters&gt;</span>
</code></pre></div></div>

<h3 id="4-authentication-check-and-pkce-generation">4. ğŸ” Authentication Check and PKCE Generation</h3>
<p>MCP server processes the request:</p>
<ul>
<li>âœ… <strong>Checks</strong> database for access token associated with Session ID</li>
<li>âŒ <strong>No token exists</strong> (first request)</li>
<li>ğŸ” <strong>Generates PKCE parameters</strong> (OAuth 2.1 requirement):</li>
<li><code>code_verifier</code>: Cryptographically random string (43-128 characters)</li>
<li><code>code_challenge</code>: SHA256 hash of code_verifier, base64url-encoded</li>
<li><code>state</code>: Cryptographically random token for CSRF protection</li>
<li>ğŸ’¾ <strong>Stores</strong> code_verifier linked to state token in database</li>
<li><strong>Responds</strong> with <code>HTTP 401</code> and authentication URL containing code_challenge</li>
</ul>
<p><strong>PKCE Parameter Generation Example:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>

<span class="c1"># Generate code_verifier (43-128 characters)</span>
<span class="n">code_verifier</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">secrets</span><span class="o">.</span><span class="n">token_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

<span class="c1"># Generate code_challenge (SHA256 of code_verifier)</span>
<span class="n">code_challenge</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span>
    <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">code_verifier</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
<span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

<span class="c1"># Store association: state_token -&gt; {code_verifier, session_id}</span>
</code></pre></div></div>

<h3 id="5-manual-user-authentication-flow-with-pkce">5. ğŸ” Manual User Authentication Flow with PKCE</h3>
<p><strong>âš ï¸ CRITICAL: GitHub Copilot Cannot Render Interactive Links</strong></p>
<p>Instead of rendering clickable links (which Copilot cannot do), the Agent:</p>
<ol>
<li><strong>Displays text message</strong> with authentication URL</li>
<li><strong>Instructs user</strong> to manually open the URL in browser</li>
<li><strong>Waits for user confirmation</strong> that authentication is complete</li>
</ol>
<p><strong>Agent Response Example:</strong></p>
<div class="codehilite"><pre><span></span><code>ğŸ” Authentication required for Rally access.

Please follow these steps:
1. Copy this URL: https://mcp.example.com/auth?state=xyz789&amp;code_challenge=abc123def456
2. Open it in your browser
3. Complete the Rally authentication
4. Return here and say &quot;authentication complete&quot;

Note: This URL includes PKCE security parameters for OAuth 2.1 compliance.
</code></pre></div></div>

<h3 id="6-user-completes-oauth-in-browser-with-pkce-manual-process">6. ğŸŒ User Completes OAuth in Browser with PKCE (Manual Process)</h3>
<p>User manually completes PKCE-protected authentication:</p>
<ol>
<li><strong>User copies URL</strong> from Copilot chat (includes code_challenge parameter)</li>
<li><strong>Opens URL in browser</strong> (separate from VSCode)</li>
<li><strong>MCP Server processes</strong> authentication request:</li>
<li>Stores code_verifier linked to state token</li>
<li>Redirects to Rally OAuth server with PKCE parameters</li>
<li><strong>Completes OAuth flow</strong> with Rally (OAuth server validates code_challenge)</li>
<li><strong>Sees success message</strong> in browser after PKCE validation</li>
<li><strong>Returns to VSCode</strong> and confirms completion</li>
</ol>
<h3 id="7-oauth-redirect-and-token-exchange-with-pkce-verification">7. ğŸ”„ OAuth Redirect and Token Exchange with PKCE Verification</h3>
<p>OAuth flow completion with PKCE validation:</p>
<ol>
<li><strong>Rally OAuth server</strong> redirects to MCP server's callback with authorization code</li>
<li><strong>MCP server callback</strong> endpoint:</li>
<li>âœ… Validates <code>state</code> parameter (CSRF protection)</li>
<li>ğŸ” Retrieves stored <code>code_verifier</code> for the state token</li>
<li>ğŸ” Retrieves associated Session ID from state mapping</li>
<li>
<p>ï¿½ <strong>PKCE Token Exchange</strong>:<br />
     ```http<br />
     POST /oauth/token<br />
     Content-Type: application/x-www-form-urlencoded</p>
<p>grant_type=authorization_code<br />
 &amp;code=authorization_code_from_rally<br />
 &amp;client_id=your_rally_client_id<br />
 &amp;code_verifier=original_code_verifier_value<br />
 &amp;redirect_uri=https://mcp.example.com/callback<br />
<code>``
   - âœ… **Rally validates**:</code>SHA256(code_verifier) == stored_code_challenge`<br />
   - ğŸ”„ <strong>Receives tokens</strong> only if PKCE verification passes<br />
   - ğŸ’¾ Stores tokens in database mapped to Session ID<br />
   - ğŸ“„ Returns HTML success page to browser</p>
</li>
</ol>
<p><strong>ğŸ” PKCE Security Benefits:</strong><br />
- Prevents authorization code interception attacks<br />
- Ensures only the client that initiated the flow can exchange the code<br />
- No client secret required (suitable for public clients)<br />
- Cryptographically binds authorization request to token request</p>
<h3 id="8-user-confirmation-and-request-retry">8. â†©ï¸ User Confirmation and Request Retry</h3>
<p><strong>Critical Step</strong>: User must manually confirm authentication completion:</p>
<ol>
<li>ï¿½ <strong>User returns to VSCode</strong> and tells Agent "authentication complete"</li>
<li>ğŸ”„ <strong>Agent retries</strong> the original request with same Session ID</li>
<li>ğŸ” <strong>MCP server finds</strong> access token for Session ID</li>
<li>ğŸ“¡ <strong>Makes authenticated</strong> API call to Rally</li>
<li>ğŸ›¡ï¸ <strong>Sanitizes response</strong> if needed</li>
<li>ğŸ“¤ <strong>Returns result</strong> to Agent</li>
<li>ğŸ’¬ <strong>Agent displays</strong> result in chat</li>
</ol>
<h3 id="key-difference-from-original-pattern">âš ï¸ <strong>Key Difference from Original Pattern</strong></h3>
<p><strong>ORIGINAL (Incorrect)</strong>: Assumed Agent could render clickable links and handle interactive OAuth</p>
<div class="codehilite"><pre><span></span><code><span class="n">Agent</span><span class="o">-&gt;&gt;</span><span class="n">User</span><span class="o">:</span><span class="w"> </span><span class="mf">8.</span><span class="w"> </span><span class="n">Render</span><span class="w"> </span><span class="s">&quot;Sign in to Rally&quot;</span><span class="w"> </span><span class="n">link</span><span class="w">  </span><span class="err">âŒ</span><span class="w"> </span><span class="kr">NOT</span><span class="w"> </span><span class="n">POSSIBLE</span>
</code></pre></div></div>

<p><strong>CORRECTED (Realistic)</strong>: Agent provides text instructions for manual authentication</p>
<div class="codehilite"><pre><span></span><code><span class="n">Agent</span><span class="o">-&gt;&gt;</span><span class="n">User</span><span class="o">:</span><span class="w"> </span><span class="mf">5.</span><span class="w"> </span><span class="n">Display</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="n">instructions</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">URL</span><span class="w">  </span><span class="err">âœ…</span><span class="w"> </span><span class="n">POSSIBLE</span>
<span class="n">User</span><span class="o">-&gt;&gt;</span><span class="n">Agent</span><span class="o">:</span><span class="w"> </span><span class="mf">15.</span><span class="w"> </span><span class="s">&quot;Authentication complete&quot;</span><span class="w">  </span><span class="err">âœ…</span><span class="w"> </span><span class="n">REQUIRED</span>
</code></pre></div></div>

<hr />
<h2 id="state-parameter-to-session-id-mapping">ï¿½ State Parameter to Session-ID Mapping</h2>
<p>The state token is critically associated with the Session-ID provided by the Agent. This association is the linchpin that allows the MCP server to "remember" which IDE session initiated the authentication request after the user completes the browser-based OAuth flow.</p>
<h3 id="detailed-state-mapping-flow">Detailed State Mapping Flow</h3>
<div class="codehilite"><pre><span></span><code><span class="n">sequenceDiagram</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Copilot</span><span class="w"> </span><span class="n">Agent</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">MCP</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="p">(</span><span class="n">GCP</span><span class="p">)</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">MCP</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">DB</span>

<span class="w">    </span><span class="n">A</span><span class="o">-&gt;&gt;</span><span class="n">M</span><span class="p">:</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">create_story</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">Headers</span><span class="p">:</span><span class="w"> </span><span class="n">Session</span><span class="o">-</span><span class="n">ID</span><span class="p">:</span><span class="w"> </span><span class="n">ABC123</span>
<span class="w">    </span><span class="n">M</span><span class="o">-&gt;&gt;</span><span class="n">DB</span><span class="p">:</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Session</span><span class="o">-</span><span class="n">ID</span><span class="p">:</span><span class="w"> </span><span class="n">ABC123</span>
<span class="w">    </span><span class="n">DB</span><span class="o">--&gt;&gt;</span><span class="n">M</span><span class="p">:</span><span class="w"> </span><span class="mf">3.</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="p">(</span><span class="n">Unauthorized</span><span class="p">)</span>
<span class="w">    </span><span class="n">M</span><span class="o">-&gt;&gt;</span><span class="n">M</span><span class="p">:</span><span class="w"> </span><span class="mf">4.</span><span class="w"> </span><span class="n">Generate</span><span class="w"> </span><span class="n">cryptographically</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="n">STATE_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="n">XYZ789</span>
<span class="w">    </span><span class="n">M</span><span class="o">-&gt;&gt;</span><span class="n">DB</span><span class="p">:</span><span class="w"> </span><span class="mf">5.</span><span class="w"> </span><span class="n">Store</span><span class="p">:</span><span class="w"> </span><span class="n">STATE_TOKEN</span><span class="o">=</span><span class="n">XYZ789</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Session</span><span class="o">-</span><span class="n">ID</span><span class="o">=</span><span class="n">ABC123</span>
<span class="w">    </span><span class="n">M</span><span class="o">--&gt;&gt;</span><span class="n">A</span><span class="p">:</span><span class="w"> </span><span class="mf">6.</span><span class="w"> </span><span class="mi">401</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">AuthURL</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="n">state</span><span class="o">=</span><span class="n">XYZ789</span><span class="p">)</span>

<span class="w">    </span><span class="n">Note</span><span class="w"> </span><span class="n">right</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">M</span><span class="p">:</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">completes</span><span class="w"> </span><span class="n">OAuth</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">browser</span><span class="o">.&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">OAuth</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">redirects</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">MCP</span><span class="w"> </span><span class="n">callback</span><span class="o">.</span>

<span class="w">    </span><span class="n">Note</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="n">DB</span><span class="p">:</span><span class="w"> </span><span class="n">OAuth</span><span class="w"> </span><span class="n">Callback</span>
<span class="w">    </span><span class="n">M</span><span class="o">-&gt;&gt;</span><span class="n">M</span><span class="p">:</span><span class="w"> </span><span class="mf">7.</span><span class="w"> </span><span class="n">Receive</span><span class="w"> </span><span class="n">GET</span><span class="w"> </span><span class="o">/</span><span class="n">callback</span><span class="err">?</span><span class="n">code</span><span class="o">=</span><span class="n">a1b2c3</span><span class="o">&amp;</span><span class="n">state</span><span class="o">=</span><span class="n">XYZ789</span>
<span class="w">    </span><span class="n">M</span><span class="o">-&gt;&gt;</span><span class="n">DB</span><span class="p">:</span><span class="w"> </span><span class="mf">8.</span><span class="w"> </span><span class="n">Look</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">state</span><span class="o">=</span><span class="n">XYZ789</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">Session</span><span class="o">-</span><span class="n">ID</span><span class="p">:</span><span class="w"> </span><span class="n">ABC123</span>
<span class="w">    </span><span class="n">M</span><span class="o">-&gt;&gt;</span><span class="n">DB</span><span class="p">:</span><span class="w"> </span><span class="mf">9.</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="n">against</span><span class="w"> </span><span class="n">Session</span><span class="o">-</span><span class="n">ID</span><span class="p">:</span><span class="w"> </span><span class="n">ABC123</span>
<span class="w">    </span><span class="n">M</span><span class="o">--&gt;&gt;</span><span class="n">Browser</span><span class="p">:</span><span class="w"> </span><span class="mf">10.</span><span class="w"> </span><span class="s2">&quot;Success! Close browser.&quot;</span>

<span class="w">    </span><span class="n">A</span><span class="o">-&gt;&gt;</span><span class="n">M</span><span class="p">:</span><span class="w"> </span><span class="mf">11.</span><span class="w"> </span><span class="n">RETRY</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">create_story</span><span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span><span class="n">Headers</span><span class="p">:</span><span class="w"> </span><span class="n">Session</span><span class="o">-</span><span class="n">ID</span><span class="p">:</span><span class="w"> </span><span class="n">ABC123</span>
<span class="w">    </span><span class="n">M</span><span class="o">-&gt;&gt;</span><span class="n">DB</span><span class="p">:</span><span class="w"> </span><span class="mf">12.</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Session</span><span class="o">-</span><span class="n">ID</span><span class="p">:</span><span class="w"> </span><span class="n">ABC123</span>
<span class="w">    </span><span class="n">M</span><span class="o">-&gt;&gt;</span><span class="n">M</span><span class="p">:</span><span class="w"> </span><span class="mf">13.</span><span class="w"> </span><span class="n">Execute</span><span class="w"> </span><span class="k">tool</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">stored</span><span class="w"> </span><span class="n">tokens</span>
<span class="w">    </span><span class="n">M</span><span class="o">--&gt;&gt;</span><span class="n">A</span><span class="p">:</span><span class="w"> </span><span class="mf">14.</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="k">tool</span><span class="w"> </span><span class="n">result</span>
</code></pre></div></div>

<h3 id="step-by-step-state-mapping-breakdown">Step-by-Step State Mapping Breakdown</h3>
<ol>
<li>
<p><strong>Initial Request with Session-ID</strong>: The Copilot Agent makes its first call to the MCP server's tool endpoint (e.g., <code>POST /tools/create_rally_story</code>). It includes the <code>Session-ID: ABC123</code> header.</p>
</li>
<li>
<p><strong>Server Generates State</strong>: The MCP server receives the request and sees that <code>Session-ID: ABC123</code> has no associated access tokens. It then:</p>
</li>
<li>Generates a unique, cryptographically random string for the state parameter (e.g., <code>XYZ789</code>)</li>
<li>
<p>Creates a crucial association in its database: it stores <code>state=XYZ789 -&gt; Session-ID=ABC123</code></p>
</li>
<li>
<p><strong>AuthURL with State</strong>: The MCP server generates the AuthURL for the OAuth provider (Rally/GitHub) and includes the generated state parameter:<br />
<code>text
   https://rally1.rallydev.com/login/oauth2/auth?response_type=code&amp;client_id=...&amp;state=XYZ789&amp;...</code></p>
</li>
<li>
<p><strong>OAuth Redirection</strong>: After the user authenticates, the OAuth server redirects back to the MCP server's callback URL with the authorization code and the original state parameter (<code>.../oauth/callback?code=a1b2c3&amp;state=XYZ789</code>).</p>
</li>
<li>
<p><strong>State Validation and Session Lookup</strong>: The MCP server's callback endpoint:</p>
</li>
<li>Receives the request with <code>?state=XYZ789</code></li>
<li>Validates the state parameter to prevent CSRF</li>
<li>Uses the state value to look up the associated Session-ID in its database</li>
<li>
<p>Finds that <code>state=XYZ789</code> is linked to <code>Session-ID=ABC123</code></p>
</li>
<li>
<p><strong>Token Storage</strong>: The MCP server exchanges the code for an access token. It then stores this access token (and refresh token) against the <code>Session-ID: ABC123</code> in its database.</p>
</li>
<li>
<p><strong>Completing the Loop</strong>: When the Copilot Agent retries the original request with <code>Session-ID: ABC123</code>, the MCP server finds the valid tokens and can execute the tool call.</p>
</li>
</ol>
<h3 id="parameter-summary">Parameter Summary</h3>
<table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
<thead>
<tr>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Parameter</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Generated By</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Purpose</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Association</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>Session-ID</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Copilot Agent</td>
<td style="border: 1px solid #ddd; padding: 12px;">A persistent identifier for the entire IDE session. Used to link all requests from the same user to their stored OAuth tokens.</td>
<td style="border: 1px solid #ddd; padding: 12px;">The key used by the MCP server to store and retrieve the user's access tokens.</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>state</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">MCP Server</td>
<td style="border: 1px solid #ddd; padding: 12px;">A one-time, unique token for the OAuth flow. Its sole purpose is to securely connect the OAuth callback response back to the original session that initiated the request.</td>
<td style="border: 1px solid #ddd; padding: 12px;">The temporary bridge. The MCP server creates a database entry that maps the state token to the Session-ID.</td>
</tr>
</tbody>
</table>
<p>This mechanism ensures that even though the OAuth flow happens out-of-band in a web browser, the resulting credentials are correctly linked to the original user session in the IDE.</p>
<hr />
<h2 id="mcp-server-implementation-code-snippets">ğŸ’» <strong>MCP Server Implementation Code Snippets</strong></h2>
<blockquote style="border-left: 4px solid #0078d4; margin: 16px 0; padding-left: 16px; color: #605e5c; font-style: italic;">
<p><strong>ğŸš€ Note: FastMCP + FastAPI Implementation</strong></p>
<p>The code snippets below use <strong>FastMCP</strong> with <strong>FastAPI</strong> instead of Flask for several important reasons:</p>
<p><strong>âœ… Native MCP Protocol Support:</strong><br />
- FastMCP provides built-in MCP tool registration and protocol handling<br />
- Automatic MCP message serialization/deseriization<br />
- Standard MCP security and authentication patterns</p>
<p><strong>âœ… Performance &amp; Modern Architecture:</strong><br />
- FastAPI is ASGI-based (faster than Flask's WSGI)<br />
- Native async/await support for better concurrency<br />
- Automatic OpenAPI documentation generation</p>
<p><strong>âœ… Type Safety &amp; Validation:</strong><br />
- Pydantic models for request/response validation<br />
- Automatic type checking and error handling<br />
- Better debugging and development experience</p>
<p><strong>âœ… MCP Ecosystem Integration:</strong><br />
- Direct compatibility with MCP clients like GitHub Copilot<br />
- Standard tool registration patterns<br />
- Built-in security hooks and middleware support</p>
</blockquote>
<h3 id="1-initial-tool-call-401-unauthorized-response">1. ğŸš« Initial Tool Call - 401 Unauthorized Response</h3>
<p><strong>FastMCP Tool</strong>: <code>create_story</code> (First Time Call)</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastmcp</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastMCP</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">Header</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="c1"># Initialize FastMCP server with FastAPI</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Rally MCP Server&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
<span class="n">mcp</span> <span class="o">=</span> <span class="n">FastMCP</span><span class="p">(</span><span class="s2">&quot;Rally Integration Server&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CreateStoryRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AuthErrorResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">error</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">error_description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">auth_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">instructions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_story_tool</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">CreateStoryRequest</span><span class="p">,</span>
    <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Header</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;Session-ID&quot;</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FastMCP tool for creating Rally stories.</span>
<span class="sd">    Returns authentication error with PKCE parameters if user not authenticated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">session_id</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Missing Session-ID header&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Check if we have valid tokens for this session</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_stored_tokens</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tokens</span><span class="p">:</span>
        <span class="c1"># Generate PKCE parameters for OAuth flow</span>
        <span class="n">pkce_data</span> <span class="o">=</span> <span class="n">generate_pkce_parameters</span><span class="p">()</span>
        <span class="n">state_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

        <span class="c1"># Store PKCE and session mapping</span>
        <span class="k">await</span> <span class="n">store_oauth_state</span><span class="p">(</span><span class="n">state_token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">pkce_data</span><span class="p">[</span><span class="s1">&#39;code_verifier&#39;</span><span class="p">])</span>

        <span class="c1"># Build authorization URL</span>
        <span class="n">auth_url</span> <span class="o">=</span> <span class="n">build_authorization_url</span><span class="p">(</span><span class="n">state_token</span><span class="p">,</span> <span class="n">pkce_data</span><span class="p">[</span><span class="s1">&#39;code_challenge&#39;</span><span class="p">])</span>

        <span class="c1"># Return authentication required error</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="n">AuthErrorResponse</span><span class="p">(</span>
                <span class="n">error</span><span class="o">=</span><span class="s2">&quot;Authentication required&quot;</span><span class="p">,</span>
                <span class="n">error_description</span><span class="o">=</span><span class="s2">&quot;User must authenticate with Rally to access this tool&quot;</span><span class="p">,</span>
                <span class="n">auth_url</span><span class="o">=</span><span class="n">auth_url</span><span class="p">,</span>
                <span class="n">instructions</span><span class="o">=</span><span class="p">[</span>
                    <span class="s2">&quot;1. Copy the auth_url and open it in your browser&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;2. Complete Rally authentication and authorization&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;3. Return to this chat and say &#39;authentication complete&#39;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;4. Retry your original request&quot;</span>
                <span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="c1"># If we reach here, tokens exist - proceed with tool execution</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">execute_create_story_tool</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_pkce_parameters</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate PKCE code_verifier and code_challenge&quot;&quot;&quot;</span>
    <span class="c1"># Generate cryptographically random code_verifier (43-128 chars)</span>
    <span class="n">code_verifier</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span>
        <span class="n">secrets</span><span class="o">.</span><span class="n">token_bytes</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

    <span class="c1"># Generate code_challenge (SHA256 of code_verifier)</span>
    <span class="n">code_challenge</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span>
        <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">code_verifier</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;code_verifier&#39;</span><span class="p">:</span> <span class="n">code_verifier</span><span class="p">,</span>
        <span class="s1">&#39;code_challenge&#39;</span><span class="p">:</span> <span class="n">code_challenge</span>
    <span class="p">}</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">store_oauth_state</span><span class="p">(</span><span class="n">state_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code_verifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store OAuth state mapping in database&quot;&quot;&quot;</span>
    <span class="c1"># Use async database operations</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">aiosqlite</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;mcp_server.db&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            INSERT INTO oauth_states (state_token, session_id, code_verifier, created_at)</span>
<span class="s1">            VALUES (?, ?, ?, ?)</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">state_token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">code_verifier</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()))</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_authorization_url</span><span class="p">(</span><span class="n">state_token</span><span class="p">,</span> <span class="n">code_challenge</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build OAuth authorization URL with PKCE parameters&quot;&quot;&quot;</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://mcp-server.example.com/auth&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">state_token</span><span class="p">,</span>
        <span class="s1">&#39;code_challenge&#39;</span><span class="p">:</span> <span class="n">code_challenge</span><span class="p">,</span>
        <span class="s1">&#39;code_challenge_method&#39;</span><span class="p">:</span> <span class="s1">&#39;S256&#39;</span>
    <span class="p">}</span>

    <span class="n">query_string</span> <span class="o">=</span> <span class="s1">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">query_string</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></div>

<p><strong>Sample 401 Response:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Authentication required&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;error_description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;User must authenticate with Rally to access this tool&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;auth_url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://mcp-server.example.com/auth?state=abc123xyz789&amp;code_challenge=5VXp1mP5z6uRxE3Xv8w7Wr2qH0nK8lL9aBc3dF1gS4iJ7yT6oM&amp;code_challenge_method=S256&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;instructions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;1. Copy the auth_url and open it in your browser&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;2. Complete Rally authentication and authorization&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="s2">&quot;3. Return to this chat and say &#39;authentication complete&#39;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;4. Retry your original request&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="2-authorization-endpoint-pkce-processing">2. ğŸ” Authorization Endpoint - PKCE Processing</h3>
<p><strong>FastAPI Endpoint</strong>: <code>GET /auth</code> (Handles PKCE and redirects to Rally)</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Query</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">RedirectResponse</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/auth&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">authorize</span><span class="p">(</span>
    <span class="n">state</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;OAuth state token&quot;</span><span class="p">),</span>
    <span class="n">code_challenge</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;PKCE code challenge&quot;</span><span class="p">),</span>
    <span class="n">code_challenge_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;PKCE challenge method&quot;</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FastAPI authorization endpoint that processes PKCE parameters</span>
<span class="sd">    and redirects user to Rally OAuth server.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">code_challenge_method</span> <span class="o">!=</span> <span class="s1">&#39;S256&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Unsupported code_challenge_method&#39;</span><span class="p">,</span>
                <span class="s1">&#39;supported&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;S256&#39;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="c1"># Verify state token exists and retrieve associated data</span>
    <span class="n">oauth_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_oauth_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">oauth_data</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid or expired state token&#39;</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="c1"># Verify code_challenge matches stored code_verifier</span>
    <span class="n">stored_verifier</span> <span class="o">=</span> <span class="n">oauth_data</span><span class="p">[</span><span class="s1">&#39;code_verifier&#39;</span><span class="p">]</span>
    <span class="n">expected_challenge</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span>
        <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">stored_verifier</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
    <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">code_challenge</span> <span class="o">!=</span> <span class="n">expected_challenge</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid code_challenge - does not match stored code_verifier&#39;</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="c1"># Build Rally OAuth URL with PKCE parameters</span>
    <span class="n">rally_oauth_url</span> <span class="o">=</span> <span class="n">build_rally_oauth_url</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">code_challenge</span><span class="p">)</span>

    <span class="c1"># Redirect user to Rally OAuth server</span>
    <span class="k">return</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">rally_oauth_url</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_oauth_state</span><span class="p">(</span><span class="n">state_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve OAuth state data from database&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">aiosqlite</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;mcp_server.db&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            SELECT session_id, code_verifier, created_at </span>
<span class="s1">            FROM oauth_states </span>
<span class="s1">            WHERE state_token = ? AND created_at &gt; datetime(&#39;now&#39;, &#39;-10 minutes&#39;)</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">state_token</span><span class="p">,))</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;session_id&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;code_verifier&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_rally_oauth_url</span><span class="p">(</span><span class="n">state_token</span><span class="p">,</span> <span class="n">code_challenge</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build Rally OAuth authorization URL&quot;&quot;&quot;</span>
    <span class="n">rally_base</span> <span class="o">=</span> <span class="s2">&quot;https://rally1.rallydev.com/login/oauth2/auth&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;response_type&#39;</span><span class="p">:</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span>
        <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="s1">&#39;your_rally_client_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;redirect_uri&#39;</span><span class="p">:</span> <span class="s1">&#39;https://mcp-server.example.com/callback&#39;</span><span class="p">,</span>
        <span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="s1">&#39;alm:read alm:write&#39;</span><span class="p">,</span>
        <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">state_token</span><span class="p">,</span>
        <span class="s1">&#39;code_challenge&#39;</span><span class="p">:</span> <span class="n">code_challenge</span><span class="p">,</span>
        <span class="s1">&#39;code_challenge_method&#39;</span><span class="p">:</span> <span class="s1">&#39;S256&#39;</span>
    <span class="p">}</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlencode</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rally_base</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></div>

<h3 id="3-oauth-callback-token-exchange">3. ğŸ”„ OAuth Callback - Token Exchange</h3>
<p><strong>Endpoint</strong>: <code>GET /callback</code> (Handles Rally OAuth callback)</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/callback&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">oauth_callback</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    OAuth callback endpoint that handles Rally&#39;s authorization response</span>
<span class="sd">    and exchanges authorization code for access tokens using PKCE.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">authorization_code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span>
    <span class="n">state_token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">)</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;html&gt;&lt;body&gt;</span>
<span class="s2">            &lt;h2&gt;âŒ Authentication Failed&lt;/h2&gt;</span>
<span class="s2">            &lt;p&gt;Error: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">            &lt;p&gt;Please close this tab and try again.&lt;/p&gt;</span>
<span class="s2">        &lt;/body&gt;&lt;/html&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="mi">400</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">authorization_code</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">state_token</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Missing authorization code or state parameter&#39;</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Retrieve OAuth state data</span>
    <span class="n">oauth_data</span> <span class="o">=</span> <span class="n">get_oauth_state</span><span class="p">(</span><span class="n">state_token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">oauth_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Invalid or expired state token&#39;</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Exchange authorization code for tokens using PKCE</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">exchange_code_for_tokens</span><span class="p">(</span>
        <span class="n">authorization_code</span><span class="p">,</span> 
        <span class="n">oauth_data</span><span class="p">[</span><span class="s1">&#39;code_verifier&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tokens</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;html&gt;&lt;body&gt;</span>
<span class="s2">            &lt;h2&gt;âŒ Token Exchange Failed&lt;/h2&gt;</span>
<span class="s2">            &lt;p&gt;Failed to obtain access tokens from Rally.&lt;/p&gt;</span>
<span class="s2">            &lt;p&gt;Please close this tab and try again.&lt;/p&gt;</span>
<span class="s2">        &lt;/body&gt;&lt;/html&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="c1"># Store tokens for the session</span>
    <span class="n">store_tokens_for_session</span><span class="p">(</span><span class="n">oauth_data</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">],</span> <span class="n">tokens</span><span class="p">)</span>

    <span class="c1"># Clean up OAuth state</span>
    <span class="n">cleanup_oauth_state</span><span class="p">(</span><span class="n">state_token</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;html&gt;&lt;body&gt;</span>
<span class="s2">        &lt;h2&gt;âœ… Authentication Successful!&lt;/h2&gt;</span>
<span class="s2">        &lt;p&gt;You have successfully authenticated with Rally.&lt;/p&gt;</span>
<span class="s2">        &lt;p&gt;&lt;strong&gt;You can now close this tab and return to VSCode.&lt;/strong&gt;&lt;/p&gt;</span>
<span class="s2">        &lt;p&gt;In VSCode, tell the agent &quot;authentication complete&quot; to continue.&lt;/p&gt;</span>
<span class="s2">        &lt;script&gt;</span>
<span class="s2">            // Optional: Auto-close after 3 seconds</span>
<span class="s2">            setTimeout(() =&gt; window.close(), 3000);</span>
<span class="s2">        &lt;/script&gt;</span>
<span class="s2">    &lt;/body&gt;&lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">exchange_code_for_tokens</span><span class="p">(</span><span class="n">authorization_code</span><span class="p">,</span> <span class="n">code_verifier</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exchange authorization code for access tokens using PKCE&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

    <span class="n">token_url</span> <span class="o">=</span> <span class="s2">&quot;https://rally1.rallydev.com/login/oauth2/token&quot;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="s1">&#39;authorization_code&#39;</span><span class="p">,</span>
        <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">authorization_code</span><span class="p">,</span>
        <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="s1">&#39;your_rally_client_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;code_verifier&#39;</span><span class="p">:</span> <span class="n">code_verifier</span><span class="p">,</span>  <span class="c1"># PKCE verification</span>
        <span class="s1">&#39;redirect_uri&#39;</span><span class="p">:</span> <span class="s1">&#39;https://mcp-server.example.com/callback&#39;</span>
    <span class="p">}</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">token_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;access_token&#39;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">],</span>
            <span class="s1">&#39;refresh_token&#39;</span><span class="p">:</span> <span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refresh_token&#39;</span><span class="p">),</span>
            <span class="s1">&#39;expires_in&#39;</span><span class="p">:</span> <span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expires_in&#39;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">),</span>
            <span class="s1">&#39;token_type&#39;</span><span class="p">:</span> <span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token_type&#39;</span><span class="p">,</span> <span class="s1">&#39;Bearer&#39;</span><span class="p">),</span>
            <span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scope&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token exchange failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">store_tokens_for_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store tokens in database mapped to session ID&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;mcp_server.db&#39;</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        INSERT OR REPLACE INTO session_tokens </span>
<span class="s1">        (session_id, access_token, refresh_token, expires_at, created_at)</span>
<span class="s1">        VALUES (?, ?, ?, datetime(&#39;now&#39;, &#39;+&#39; || ? || &#39; seconds&#39;), ?)</span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="n">session_id</span><span class="p">,</span> 
        <span class="n">tokens</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">],</span> 
        <span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refresh_token&#39;</span><span class="p">),</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expires_in&#39;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">),</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="p">))</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cleanup_oauth_state</span><span class="p">(</span><span class="n">state_token</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove OAuth state after successful token exchange&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;mcp_server.db&#39;</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM oauth_states WHERE state_token = ?&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">state_token</span><span class="p">,))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="4-tool-execution-authenticated-request">4. âœ… Tool Execution - Authenticated Request</h3>
<p><strong>Endpoint</strong>: <code>POST /tools/create-story</code> (Retry After Authentication)</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">execute_create_story_tool</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">request_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the create story tool with authenticated Rally API calls.</span>
<span class="sd">    Called when valid tokens exist for the session.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Extract story details from request</span>
        <span class="n">story_title</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;New Story&#39;</span><span class="p">)</span>
        <span class="n">story_description</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">story_points</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Make authenticated Rally API call</span>
        <span class="n">rally_response</span> <span class="o">=</span> <span class="n">create_rally_story</span><span class="p">(</span>
            <span class="n">tokens</span><span class="p">[</span><span class="s1">&#39;access_token&#39;</span><span class="p">],</span>
            <span class="n">story_title</span><span class="p">,</span>
            <span class="n">story_description</span><span class="p">,</span> 
            <span class="n">story_points</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">rally_response</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Rally story created successfully&#39;</span><span class="p">,</span>
                <span class="s1">&#39;story&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">rally_response</span><span class="p">[</span><span class="s1">&#39;ObjectID&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;formatted_id&#39;</span><span class="p">:</span> <span class="n">rally_response</span><span class="p">[</span><span class="s1">&#39;FormattedID&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">rally_response</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">rally_response</span><span class="p">[</span><span class="s1">&#39;ScheduleState&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;https://rally1.rallydev.com/#/detail/userstory/</span><span class="si">{</span><span class="n">rally_response</span><span class="p">[</span><span class="s1">&#39;ObjectID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Failed to create Rally story&#39;</span><span class="p">,</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Rally API call failed&#39;</span>
            <span class="p">}),</span> <span class="mi">500</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Tool execution failed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">}),</span> <span class="mi">500</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_rally_story</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a story in Rally using the API&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

    <span class="n">rally_api_url</span> <span class="o">=</span> <span class="s2">&quot;https://rally1.rallydev.com/slm/webservice/v2.0/hierarchicalrequirement&quot;</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span>
    <span class="p">}</span>

    <span class="n">story_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;HierarchicalRequirement&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s1">&#39;Description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;PlanEstimate&#39;</span><span class="p">:</span> <span class="n">points</span><span class="p">,</span>
            <span class="s1">&#39;ScheduleState&#39;</span><span class="p">:</span> <span class="s1">&#39;Defined&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">rally_api_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">story_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;CreateResult&#39;</span><span class="p">][</span><span class="s1">&#39;Object&#39;</span><span class="p">]</span>

    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rally API call failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_stored_tokens</span><span class="p">(</span><span class="n">session_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve stored tokens for a session&quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;mcp_server.db&#39;</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        SELECT access_token, refresh_token, expires_at</span>
<span class="s1">        FROM session_tokens </span>
<span class="s1">        WHERE session_id = ? AND expires_at &gt; datetime(&#39;now&#39;)</span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">session_id</span><span class="p">,))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;access_token&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;refresh_token&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s1">&#39;expires_at&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></div>

<p><strong>Sample Successful Response:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Rally story created successfully&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;story&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;12345678901&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;formatted_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;US1234&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Implement user authentication&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;state&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Defined&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://rally1.rallydev.com/#/detail/userstory/12345678901&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="5-database-schema">5. ğŸ—ƒï¸ Database Schema</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">-- OAuth state tracking table</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">oauth_states</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTOINCREMENT</span><span class="p">,</span>
<span class="w">    </span><span class="n">state_token</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">code_verifier</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span>
<span class="p">);</span>

<span class="c1">-- Session tokens table  </span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">session_tokens</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">AUTOINCREMENT</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_id</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">access_token</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">refresh_token</span><span class="w"> </span><span class="nb">TEXT</span><span class="p">,</span>
<span class="w">    </span><span class="n">expires_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span>
<span class="p">);</span>

<span class="c1">-- Index for performance</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_oauth_states_state_token</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">oauth_states</span><span class="p">(</span><span class="n">state_token</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_session_tokens_session_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">session_tokens</span><span class="p">(</span><span class="n">session_id</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="fastmcp-installation-setup">ï¿½ <strong>FastMCP Installation &amp; Setup</strong></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Install FastMCP and dependencies</span>
pip<span class="w"> </span>install<span class="w"> </span>fastmcp<span class="w"> </span>fastapi<span class="w"> </span>uvicorn<span class="w"> </span>aiosqlite<span class="w"> </span>httpx<span class="w"> </span>pydantic

<span class="c1"># Run the MCP server</span>
uvicorn<span class="w"> </span>main:app<span class="w"> </span>--host<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span>--port<span class="w"> </span><span class="m">8000</span><span class="w"> </span>--reload
</code></pre></div></div>

<p><strong>Key Dependencies:</strong><br />
- <code>fastmcp</code>: Native MCP protocol implementation<br />
- <code>fastapi</code>: Modern, fast web framework for APIs<br />
- <code>uvicorn</code>: ASGI server for FastAPI<br />
- <code>aiosqlite</code>: Async SQLite database operations<br />
- <code>httpx</code>: Async HTTP client for Rally API calls<br />
- <code>pydantic</code>: Data validation and serialization</p>
<p><strong>Why FastMCP &gt; Flask:</strong><br />
- âœ… Built-in MCP protocol support<br />
- âœ… Async performance advantages<br />
- âœ… Automatic OpenAPI documentation<br />
- âœ… Type safety with Pydantic models<br />
- âœ… Better error handling and debugging</p>
<h3 id="security-notes">ï¿½ğŸ”’ <strong>Security Notes</strong></h3>
<ol>
<li><strong>PKCE Verification</strong>: Code challenge is verified against code verifier during token exchange</li>
<li><strong>State Token Expiration</strong>: OAuth states expire after 10 minutes for security</li>
<li><strong>Token Storage</strong>: Access tokens are securely stored and automatically expire</li>
<li><strong>Session Isolation</strong>: Each Agent session has isolated token storage</li>
<li><strong>HTTPS Required</strong>: All OAuth flows must use HTTPS in production</li>
<li><strong>Input Validation</strong>: All endpoints validate required parameters and formats</li>
</ol>
<p>These code snippets provide a complete implementation of the PKCE-enabled OAuth 2.1 flow that GitHub Copilot Agent can successfully interact with using the manual authentication pattern.</p>
<hr />
<h2 id="key-points">ğŸ”‘ Key Points</h2>
<table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
<thead>
<tr>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Aspect</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ†” <strong>Session ID Management</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Generated once by Agent and used consistently to maintain state</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ” <strong>OAuth 2.1 with PKCE</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">MCP server implements full PKCE flow (code_verifier + code_challenge) for security</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸŒ <strong>Manual Authentication</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>CRITICAL</strong>: User must manually open browser and complete OAuth (Agent cannot render interactive links)</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ’¬ <strong>User Confirmation Required</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">User must return to Agent and confirm "authentication complete" before retry</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ”„ <strong>Manual Retry Trigger</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Agent retries original request only after user confirmation (no automatic retry)</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ›¡ï¸ <strong>PKCE Security</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Prevents authorization code interception; cryptographically binds auth request to token exchange</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ï¿½ <strong>State Parameter</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">CSRF protection that links OAuth callback to original Agent session</td>
</tr>
</tbody>
</table>
<h2 id="pkce-implementation-details">ğŸ” <strong>PKCE Implementation Details</strong></h2>
<table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
<thead>
<tr>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">PKCE Component</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Purpose</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>code_verifier</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Secret random string (43-128 chars)</td>
<td style="border: 1px solid #ddd; padding: 12px;">Generated by MCP Server, stored temporarily</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>code_challenge</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">SHA256 hash of code_verifier</td>
<td style="border: 1px solid #ddd; padding: 12px;">Included in authorization URL, sent to OAuth server</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>code_challenge_method</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Hashing method (always "S256")</td>
<td style="border: 1px solid #ddd; padding: 12px;">Tells OAuth server how to verify the challenge</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>PKCE Verification</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">OAuth server validates verifier matches challenge</td>
<td style="border: 1px solid #ddd; padding: 12px;"><code>SHA256(code_verifier) == code_challenge</code></td>
</tr>
</tbody>
</table>
<p><strong>ğŸ”’ PKCE Security Flow:</strong><br />
1. MCP Server generates random <code>code_verifier</code><br />
2. MCP Server creates <code>code_challenge = SHA256(code_verifier)</code><br />
3. Authorization URL includes <code>code_challenge</code> parameter<br />
4. OAuth server stores <code>code_challenge</code> for this authorization request<br />
5. Token exchange includes original <code>code_verifier</code><br />
6. OAuth server verifies <code>SHA256(received_code_verifier) == stored_code_challenge</code><br />
7. Tokens issued only if PKCE verification passes</p>
<hr />
<h2 id="realistic-user-experience-example">ğŸ’¬ <strong>Realistic User Experience Example</strong></h2>
<p>Here's what the actual conversation flow looks like in GitHub Copilot:</p>
<h3 id="initial-request">Initial Request</h3>
<p><strong>User</strong>: "Create a Rally story for implementing user authentication"</p>
<p><strong>Copilot</strong>: </p>
<div class="codehilite"><pre><span></span><code><span class="err">ğŸ”</span><span class="w"> </span><span class="nx">I</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">authenticate</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">Rally</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">stories</span><span class="p">.</span><span class="w"> </span>

<span class="nx">Please</span><span class="w"> </span><span class="nx">follow</span><span class="w"> </span><span class="nx">these</span><span class="w"> </span><span class="nx">steps</span><span class="p">:</span>
<span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nx">Copy</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">URL</span><span class="p">:</span><span class="w"> </span><span class="nx">https</span><span class="p">:</span><span class="c1">//rally-mcp-server.gcp.cloud/auth?state=abc123xyz</span>
<span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="nx">Open</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">browser</span>
<span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nx">Sign</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">Rally</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">authorize</span><span class="w"> </span><span class="nx">access</span>
<span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="nx">Once</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">see</span><span class="w"> </span><span class="s">&quot;Authentication successful&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">here</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="s">&quot;authentication complete&quot;</span>

<span class="nx">I</span><span class="err">&#39;</span><span class="nx">ll</span><span class="w"> </span><span class="nx">wait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">confirmation</span><span class="w"> </span><span class="nx">before</span><span class="w"> </span><span class="nx">proceeding</span><span class="p">.</span>
</code></pre></div></div>

<h3 id="after-user-completes-oauth">After User Completes OAuth</h3>
<p><strong>User</strong>: "authentication complete"</p>
<p><strong>Copilot</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="err">âœ…</span><span class="w"> </span><span class="n">Great</span><span class="err">!</span><span class="w"> </span><span class="n">Let</span><span class="w"> </span><span class="n">me</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">Rally</span><span class="w"> </span><span class="n">story</span><span class="w"> </span><span class="n">now</span><span class="p">...</span>

<span class="err">ğŸ“</span><span class="w"> </span><span class="n">Rally</span><span class="w"> </span><span class="n">story</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="nl">successfully</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="nl">Title</span><span class="p">:</span><span class="w"> </span><span class="ss">&quot;Implement user authentication&quot;</span>
<span class="o">-</span><span class="w"> </span><span class="nl">ID</span><span class="p">:</span><span class="w"> </span><span class="n">US12345</span>
<span class="o">-</span><span class="w"> </span><span class="nl">Status</span><span class="p">:</span><span class="w"> </span><span class="n">Defined</span>
<span class="o">-</span><span class="w"> </span><span class="nl">Owner</span><span class="p">:</span><span class="w"> </span><span class="n">john</span><span class="p">.</span><span class="n">doe</span><span class="nv">@company</span><span class="p">.</span><span class="n">com</span>

<span class="n">The</span><span class="w"> </span><span class="n">story</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">added</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="n">iteration</span><span class="p">.</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">at</span><span class="err">:</span>
<span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">rally1</span><span class="p">.</span><span class="n">rallydev</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">d</span><span class="o">/</span><span class="n">s</span><span class="o">/</span><span class="n">stories</span><span class="o">/</span><span class="n">US12345</span>
</code></pre></div></div>

<h3 id="subsequent-requests-already-authenticated">Subsequent Requests (Already Authenticated)</h3>
<p><strong>User</strong>: "Create another Rally story for API testing"</p>
<p><strong>Copilot</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="err">ğŸ“</span><span class="w"> </span><span class="n">Rally</span><span class="w"> </span><span class="n">story</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="nl">successfully</span><span class="p">:</span>
<span class="o">-</span><span class="w"> </span><span class="nl">Title</span><span class="p">:</span><span class="w"> </span><span class="ss">&quot;Implement API testing framework&quot;</span>
<span class="o">-</span><span class="w"> </span><span class="nl">ID</span><span class="p">:</span><span class="w"> </span><span class="n">US12346</span>
<span class="o">-</span><span class="w"> </span><span class="nl">Status</span><span class="p">:</span><span class="w"> </span><span class="n">Defined</span>
<span class="o">-</span><span class="w"> </span><span class="nl">Owner</span><span class="p">:</span><span class="w"> </span><span class="n">john</span><span class="p">.</span><span class="n">doe</span><span class="nv">@company</span><span class="p">.</span><span class="n">com</span>

<span class="n">Since</span><span class="w"> </span><span class="n">you</span><span class="err">&#39;</span><span class="n">re</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="n">authenticated</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">able</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">story</span><span class="w"> </span><span class="n">immediately</span><span class="p">.</span>
</code></pre></div></div>

<h2 id="configuration-example-mcpjson">âš™ï¸ Configuration Example (<code>mcp.json</code>)</h2>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;mcpServers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;rally-mcp-server&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://rally-mcp-server.gcp.cloud&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;Session-ID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$COPILOT_MCP_SESSION_ID&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;tools&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;get_rally_issue&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="s2">&quot;create_rally_defect&quot;</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;env&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;RALLY_OAUTH_CLIENT_ID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;COPILOT_MCP_RALLY_CLIENT_ID&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;RALLY_OAUTH_CLIENT_SECRET&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;COPILOT_MCP_RALLY_CLIENT_SECRET&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />
<h2 id="oauth-21-authurl-examples-with-pkce">ğŸ”— OAuth 2.1 AuthURL Examples with PKCE</h2>
<p>Here are examples of AuthURLs that an MCP server would generate for Rally and GitHub, based on the OAuth 2.1 authorization code flow with PKCE (Proof Key for Code Exchange), which is <strong>MANDATORY</strong> for OAuth 2.1 compliance.</p>
<h3 id="example-authurl-for-rally-with-pkce">Example AuthURL for Rally (with PKCE)</h3>
<div class="codehilite"><pre><span></span><code>https://rally1.rallydev.com/login/oauth2/auth?
  response_type=code
  &amp;client_id=your_rally_client_id
  &amp;redirect_uri=https://your-mcp-server.gcp.cloud/oauth/callback
  &amp;scope=alm:read%20alm:write
  &amp;state=7a3f81b0e5c2d4a6b9c8e1f2a7d3e5c8
  &amp;code_challenge=5VXp1mP5z6uRxE3Xv8w7Wr2qH0nK8lL9aBc3dF1gS4iJ7yT6oM
  &amp;code_challenge_method=S256
</code></pre></div></div>

<h3 id="example-authurl-for-github-with-pkce">Example AuthURL for GitHub (with PKCE)</h3>
<div class="codehilite"><pre><span></span><code>https://github.com/login/oauth/authorize?
  response_type=code
  &amp;client_id=your_github_client_id
  &amp;redirect_uri=https://your-mcp-server.gcp.cloud/oauth/callback
  &amp;scope=repo%20read:user
  &amp;state=8b4c6e2a1d9f3e7c5a0b2d8e3f1a5c7b
  &amp;code_challenge=kL9aBc3dF1gS4iJ7yT6oM5VXp1mP5z6uRxE3Xv8w7Wr2qH0n
  &amp;code_challenge_method=S256
</code></pre></div></div>

<h3 id="pkce-parameters-explained">ğŸ” PKCE Parameters Explained</h3>
<table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
<thead>
<tr>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Parameter</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Description</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Example Value</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Security Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>code_challenge</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">SHA256 hash of code_verifier (base64url-encoded)</td>
<td style="border: 1px solid #ddd; padding: 12px;"><code>5VXp1mP5z6uRxE3Xv8w7Wr2qH0nK8lL9aBc3dF1gS4iJ7yT6oM</code></td>
<td style="border: 1px solid #ddd; padding: 12px;">Prevents authorization code interception</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>code_challenge_method</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Hashing method for PKCE</td>
<td style="border: 1px solid #ddd; padding: 12px;"><code>S256</code> (SHA256)</td>
<td style="border: 1px solid #ddd; padding: 12px;">Tells OAuth server how to verify challenge</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>state</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">CSRF protection token</td>
<td style="border: 1px solid #ddd; padding: 12px;"><code>7a3f81b0e5c2d4a6b9c8e1f2a7d3e5c8</code></td>
<td style="border: 1px solid #ddd; padding: 12px;">Links OAuth callback to original session</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong>code_verifier</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Original random string (NOT in URL)</td>
<td style="border: 1px solid #ddd; padding: 12px;"><code>7w8x9y0z1a2b3c4d5e6f</code></td>
<td style="border: 1px solid #ddd; padding: 12px;">Sent later during token exchange</td>
</tr>
</tbody>
</table>
<h3 id="pkce-security-flow">ğŸ›¡ï¸ PKCE Security Flow</h3>
<div class="codehilite"><pre><span></span><code><span class="nf">graph</span><span class="w"> </span><span class="n">LR</span>
<span class="w">    </span><span class="n">A</span><span class="p">[</span><span class="n">MCP</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">Generates</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">code_verifier</span><span class="p">]</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">[</span><span class="n">Calculate</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">code_challenge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SHA256</span><span class="p">]</span>
<span class="w">    </span><span class="n">B</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">C</span><span class="p">[</span><span class="n">Include</span><span class="w"> </span><span class="n">code_challenge</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="kr">in</span><span class="w"> </span><span class="n">Auth</span><span class="w"> </span><span class="n">URL</span><span class="p">]</span>
<span class="w">    </span><span class="n">C</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">D</span><span class="p">[</span><span class="n">User</span><span class="w"> </span><span class="n">Completes</span><span class="w"> </span><span class="n">OAuth</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">at</span><span class="w"> </span><span class="n">OAuth</span><span class="w"> </span><span class="n">Server</span><span class="p">]</span>
<span class="w">    </span><span class="n">D</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">E</span><span class="p">[</span><span class="n">OAuth</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">Stores</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">code_challenge</span><span class="p">]</span>
<span class="w">    </span><span class="n">E</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">F</span><span class="p">[</span><span class="n">Authorization</span><span class="w"> </span><span class="n">Code</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">Returned</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">MCP</span><span class="w"> </span><span class="n">Server</span><span class="p">]</span>
<span class="w">    </span><span class="n">F</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">MCP</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">Sends</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">code_verifier</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="kt">Token</span><span class="w"> </span><span class="n">Request</span><span class="p">]</span>
<span class="w">    </span><span class="n">G</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">H</span><span class="p">[</span><span class="n">OAuth</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">Verifies</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="n">SHA256</span><span class="w"> </span><span class="n">Match</span><span class="p">]</span>
<span class="w">    </span><span class="n">H</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">I</span><span class="p">[</span><span class="n">Tokens</span><span class="w"> </span><span class="n">Issued</span><span class="w"> </span><span class="kr">Only</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="nf">if</span><span class="w"> </span><span class="n">PKCE</span><span class="w"> </span><span class="n">Valid</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="key-components-explained">ğŸ” Key Components Explained</h3>
<p>Both URLs include these standard OAuth 2.1 parameters:</p>
<table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
<thead>
<tr>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Parameter</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong><code>response_type=code</code></strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Indicates the authorization code flow is being used</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong><code>client_id</code></strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">The unique identifier for your MCP server registered with the OAuth provider (Rally or GitHub)</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong><code>redirect_uri</code></strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">The endpoint on your MCP server that will handle the OAuth callback. This must match exactly with the URI registered with the OAuth provider</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong><code>scope</code></strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Specifies the level of access being requested:<br/>â€¢ <strong>Rally</strong>: <code>alm:read alm:write</code> (for accessing Rally's Application Lifecycle Management features)<br/>â€¢ <strong>GitHub</strong>: <code>repo read:user</code> (for repository access and reading user profile data)</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong><code>state</code></strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">A unique, cryptographically random string generated by the MCP server for each authorization request. Used to maintain state between the request and callback and prevent CSRF attacks. The MCP server stores this value and associates it with the user's session</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong><code>code_challenge</code></strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">A Base64URL-encoded SHA-256 hash of a cryptographically random <code>code_verifier</code>. Part of the PKCE extension that protects against authorization code interception attacks</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;"><strong><code>code_challenge_method=S256</code></strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Indicates that SHA-256 is used for the PKCE code challenge</td>
</tr>
</tbody>
</table>
<h3 id="how-the-mcp-server-uses-this-url">ğŸ”„ How the MCP Server Uses This URL</h3>
<ol>
<li>
<p><strong>Unauthenticated Request</strong>: When an unauthenticated user makes a request, the MCP server returns an HTTP 401 Unauthorized status code</p>
</li>
<li>
<p><strong>Resource Discovery</strong>: The response includes a <code>WWW-Authenticate</code> header containing a link to its resource metadata endpoint (e.g., <code>https://your-mcp-server.gcp.cloud/.well-known/oauth-protected-resource</code>)</p>
</li>
<li>
<p><strong>Client Discovery</strong>: The client (like Copilot) uses this metadata to discover the <code>authorization_servers</code> and required scopes</p>
</li>
<li>
<p><strong>AuthURL Construction</strong>: The client constructs the appropriate AuthURL (like the examples above) and directs the user to it</p>
</li>
<li>
<p><strong>Authentication &amp; Consent</strong>: User authenticates and grants consent on the Rally or GitHub page</p>
</li>
<li>
<p><strong>Code Exchange</strong>: The OAuth server redirects back to the MCP server's <code>redirect_uri</code> with an authorization code and the original state parameter</p>
</li>
<li>
<p><strong>Token Exchange</strong>: The MCP server exchanges this code for an access token using the PKCE <code>code_verifier</code></p>
</li>
</ol>
<hr />
<h2 id="security-considerations">ï¿½ğŸ”’ Security Considerations</h2>
<table style="border-collapse: collapse; width: 100%; margin: 16px 0;">
<thead>
<tr>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Security Measure</th>
<th style="border: 1px solid #ddd; padding: 12px; background-color: #f6f8fa; text-align: left;">Implementation</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ” <strong>Token Storage</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Tokens stored securely on MCP server, not on client</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ›¡ï¸ <strong>Context Sanitization</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Performed on MCP server before sending responses to Agent</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">âœ… <strong>Input Validation</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Sanitization implemented on MCP server</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ¯ <strong>Authorization Checks</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Fine-grained checks performed against Rally APIs</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ”’ <strong>PKCE Protection</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">Prevents authorization code interception attacks</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 12px;">ğŸ² <strong>State Parameter</strong></td>
<td style="border: 1px solid #ddd; padding: 12px;">CSRF protection linking authentication to specific requests</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="benefits">ğŸ† Benefits</h2>
<ul>
<li>ğŸ”„ <strong>Seamless Integration</strong>: Natural OAuth flow within Copilot Agent experience</li>
<li>ğŸ›¡ï¸ <strong>Security First</strong>: Comprehensive security measures and best practices</li>
<li>ğŸ¯ <strong>Extensible Pattern</strong>: Reusable architecture for other authenticated APIs</li>
<li>ğŸ‘¤ <strong>User-Friendly</strong>: Minimal user intervention required for authentication</li>
<li>ğŸ“Š <strong>Session Management</strong>: Persistent authentication across multiple requests</li>
</ul>
<hr />
<p>This workflow provides a <strong>secure, extensible pattern</strong> for integrating authenticated tools into the <strong>GitHub Copilot Agent experience</strong> with <strong>Rally API integration</strong>.</p>
<hr />
<p><em>ğŸ“ Generated from VSCode Copilot Agent MCP Server documentation</em></p>